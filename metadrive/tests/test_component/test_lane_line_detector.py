"""
This test script makes sure that the detection result is the same as the visualization results.
"""
import numpy as np

from metadrive.envs.metadrive_env import MetaDriveEnv

pg_gt_1 = [
    0.1267634779214859,
    0.11392685770988464,
    0.1044268012046814,
    0.0990290567278862,
    0.0957709476351738,
    0.09482643008232117,
    0.09539368003606796,
    0.09751298278570175,
    0.10115782171487808,
    0.10696601122617722,
    0.11759728938341141,
    0.13363347947597504,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.8871590495109558,
    0.6441130638122559,
    0.5090571641921997,
    0.40979763865470886,
    0.33093956112861633,
    0.2702655494213104,
    0.2258983850479126,
    0.19412241876125336,
    0.17001909017562866,
    0.15213795006275177,
    0.1396520584821701,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.11626093089580536,
    0.11947877705097198,
    0.12490776181221008,
    0.13305042684078217,
    0.14444735646247864,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.24059288203716278,
    0.2903081476688385,
    0.3573307991027832,
    0.44379305839538574,
    0.5522155165672302,
    0.6746124625205994,
    0.8479273319244385,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.5,
    0.013087914325296879,
    0.5,
    0.5,
    0.5,
    1.3328003660717513e-06,
    0.1267634779214859,
    0.028144173324108124,
    0.02637900784611702,
    0.025196190923452377,
    0.024484261870384216,
    0.02418249100446701,
    0.024266058579087257,
    0.024741727858781815,
    0.025649012997746468,
    0.027068454772233963,
    0.02914074808359146,
    0.03210511431097984,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.08154026418924332,
    0.4780718982219696,
    0.3471904695034027,
    0.40979763865470886,
    0.33093956112861633,
    0.12774471938610077,
    0.2258983850479126,
    0.19412241876125336,
    0.0699082463979721,
    0.061508193612098694,
    0.05566595867276192,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.04554778337478638,
    0.0469503253698349,
    0.04925423115491867,
    0.052669137716293335,
    0.05756601318717003,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.10870824009180069,
    0.2903081476688385,
    0.19524239003658295,
    0.44379305839538574,
    0.3930048644542694,
    0.1347915232181549,
    0.06913679838180542,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.0045279692858457565,
    0.43315500020980835,
    0.0,
    0.5,
    0.5,
    0.2699264585971832,
    0.41499999165534973,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_2 = [
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5600000023841858,
    1.0,
    1.0,
    0.5600000023841858,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5199999809265137,
    0.7099999785423279,
    0.8999999761581421,
    1.0,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.3400000035762787,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.3400000035762787,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.8999999761581421,
    0.18000000715255737,
    0.10999999940395355,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.30000001192092896,
    0.5,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.5,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_3 = [
    0.17000000178813934,
    0.18000000715255737,
    0.18000000715255737,
    0.1899999976158142,
    0.20000000298023224,
    0.2199999988079071,
    0.23999999463558197,
    0.27000001072883606,
    0.33000001311302185,
    0.4099999964237213,
    0.5600000023841858,
    1.0,
    1.0,
    0.550000011920929,
    0.18000000715255737,
    0.10999999940395355,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.029999999329447746,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.7099999785423279,
    0.8799999952316284,
    1.0,
    0.4099999964237213,
    0.33000001311302185,
    0.27000001072883606,
    0.23999999463558197,
    0.2199999988079071,
    0.20000000298023224,
    0.1899999976158142,
    0.18000000715255737,
    0.18000000715255737,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.17000000178813934,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.27000001072883606,
    0.1899999976158142,
    0.4099999964237213,
    0.10999999940395355,
    0.18000000715255737,
    0.5600000023841858,
    0.550000011920929,
    0.18000000715255737,
    0.10999999940395355,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.029999999329447746,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.7099999785423279,
    0.7400000095367432,
    0.7799999713897705,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.23999999463558197,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.18000000715255737,
    0.18000000715255737,
    0.30000001192092896,
    0.4300000071525574,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.4300000071525574,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_pg_map(render=False):
    env = MetaDriveEnv(
        {
            "use_render": render,
            # "debug_static_world": render,
            # "debug": render,
            "num_scenarios": 1,
            "traffic_density": 0,
            "start_seed": 74,
            "map": 1,
            "vehicle_config": {
                "lidar": dict(num_lasers=10, distance=50),
                "side_detector": dict(num_lasers=50, distance=50),
                "lane_line_detector": dict(num_lasers=50, distance=50),
            },
        }
    )
    try:
        env.reset()
        env.vehicle.set_position([73, 12])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(pg_gt_1, np.round(o, 2), decimal=2)

        env.vehicle.set_position([30, 3.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_2), o, decimal=2)

        env.vehicle.set_position([30, 10.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_3), o, decimal=2)
    finally:
        env.close()


nuscenes_gt_1 = [
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    0.5260612368583679,
    0.4140831232070923,
    0.5,
    0.5,
    0.5,
    7.98985729488777e-06,
    0.09075836837291718,
    0.09217660874128342,
    0.09512805193662643,
    0.09983530640602112,
    0.10680267214775085,
    0.1167638823390007,
    0.1310119777917862,
    0.15133075416088104,
    0.18281413614749908,
    0.23800653219223022,
    0.34642189741134644,
    0.515292227268219,
    1.0,
    1.0,
    0.13423746824264526,
    0.08499415963888168,
    0.06419597566127777,
    0.17124240100383759,
    0.2518191933631897,
    0.1298043578863144,
    0.11819353699684143,
    0.18915213644504547,
    0.031741853803396225,
    0.0306671354919672,
    0.030122023075819016,
    0.030061837285757065,
    0.03048192895948887,
    0.03141561895608902,
    0.03294506296515465,
    0.03521399199962616,
    0.03834167867898941,
    0.2447834461927414,
    0.2836225926876068,
    0.3439478874206543,
    0.2683734595775604,
    1.0,
    0.21661706268787384,
    0.3294958174228668,
    0.508394181728363,
    0.6357858180999756,
    0.25371864438056946,
    0.18996702134609222,
    0.15642258524894714,
    0.13358451426029205,
    0.11820243299007416,
    0.1074109822511673,
    0.10005706548690796,
    0.09534407407045364,
    0.09228227287530899,
    0.09079291671514511,
    0.5623959898948669,
    0.5623959898948669,
    0.5956567525863647,
    0.5956567525863647,
    0.6289005875587463,
    0.6289005875587463,
    0.6621062755584717,
    0.6621062755584717,
    0.6952372789382935,
    0.6952372789382935,
    0.7282377481460571,
    0.7282377481460571,
    0.7610746622085571,
    0.7610746622085571,
    0.7936805486679077,
    0.7936805486679077,
    0.8258141875267029,
    0.8258141875267029,
    0.5182746052742004,
    0.5082992911338806,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]
nuscenes_gt_2 = [
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    0.39886173605918884,
    0.3929330110549927,
    0.5,
    0.5,
    0.5,
    0.00012117374717490748,
    1.0,
    0.7808146476745605,
    0.4016971290111542,
    0.4970487654209137,
    0.21977421641349792,
    0.1833307445049286,
    0.2741360664367676,
    0.24397584795951843,
    0.22295309603214264,
    0.20816056430339813,
    0.1983921080827713,
    0.19227470457553864,
    0.18942095339298248,
    0.19004100561141968,
    0.19369380176067352,
    0.20063059031963348,
    0.11725883930921555,
    0.1259033977985382,
    0.13827748596668243,
    0.15607935190200806,
    0.18244585394859314,
    0.22377735376358032,
    0.2953443229198456,
    0.44443684816360474,
    0.9753272533416748,
    0.11670814454555511,
    0.041685495525598526,
    0.038300298154354095,
    0.03590720146894455,
    0.034303367137908936,
    0.03333956375718117,
    0.03293337672948837,
    0.03305184096097946,
    0.03565486893057823,
    0.045187562704086304,
    0.06304076313972473,
    1.0,
    0.927940845489502,
    0.47582200169563293,
    0.32681402564048767,
    0.252807080745697,
    0.20891286432743073,
    0.1803870052099228,
    0.1609482318162918,
    0.14739003777503967,
    0.13794484734535217,
    0.1312611699104309,
    0.12699010968208313,
    0.12537787854671478,
    0.1267206221818924,
    0.4396708011627197,
    0.4396708011627197,
    0.4618304371833801,
    0.4618304371833801,
    0.483804315328598,
    0.483804315328598,
    0.505452036857605,
    0.505452036857605,
    0.5266749858856201,
    0.5266749858856201,
    0.547338604927063,
    0.547338604927063,
    0.5673576593399048,
    0.5673576593399048,
    0.5866857767105103,
    0.5866857767105103,
    0.6053164601325989,
    0.6053164601325989,
    0.0,
    0.4675830006599426,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_nuscenes(render=False):
    from metadrive.engine.asset_loader import AssetLoader
    from metadrive.envs.scenario_env import ScenarioEnv

    NuScenesEnv = ScenarioEnv

    env = NuScenesEnv(
        {
            "use_render": render,
            # "agent_policy": ReplayEgoCarPolicy,
            "no_traffic": True,
            "debug_static_world": render,
            "debug": render,
            "show_sidewalk": True,
            "show_crosswalk": True,
            "camera_dist": 9,
            "start_scenario_index": 0,
            "num_scenarios": 10,
            "horizon": 1000,
            "vehicle_config": dict(
                show_navi_mark=False,
                lidar=dict(num_lasers=10, distance=50),
                lane_line_detector=dict(num_lasers=50, distance=50),
                side_detector=dict(num_lasers=50, distance=50)
            ),
            "data_directory": AssetLoader.file_path("nuscenes", unix_style=False),
        }
    )
    try:
        env.reset(seed=0)
        env.vehicle.set_position([-9.4, -27.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_1, o, decimal=3)

        env.reset(seed=1)
        env.vehicle.set_position([79.96, -6.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_2, o, decimal=3)
    finally:
        env.close()


if __name__ == '__main__':
    # test_nuscenes(True)
    test_pg_map(True)
