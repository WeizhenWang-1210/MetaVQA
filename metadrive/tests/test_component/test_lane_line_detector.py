"""
This test script makes sure that the detection result is the same as the visualization results.
"""
import numpy as np

from metadrive.envs.metadrive_env import MetaDriveEnv

pg_gt_1 = [
    0.1267634779214859,
    0.11392685770988464,
    0.1044268012046814,
    0.0990290567278862,
    0.0957709476351738,
    0.09482643008232117,
    0.09539368003606796,
    0.09751298278570175,
    0.10115782171487808,
    0.10696601122617722,
    0.11759728938341141,
    0.13363347947597504,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.8871590495109558,
    0.6441130638122559,
    0.5090571641921997,
    0.40979763865470886,
    0.33093956112861633,
    0.2702655494213104,
    0.2258983850479126,
    0.19412241876125336,
    0.17001909017562866,
    0.15213795006275177,
    0.1396520584821701,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.11626093089580536,
    0.11947877705097198,
    0.12490776181221008,
    0.13305042684078217,
    0.14444735646247864,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.24059288203716278,
    0.2903081476688385,
    0.3573307991027832,
    0.44379305839538574,
    0.5522155165672302,
    0.6746124625205994,
    0.8479273319244385,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.5,
    0.013087914325296879,
    0.5,
    0.5,
    0.5,
    1.3328003660717513e-06,
    0.1267634779214859,
    0.028144173324108124,
    0.02637900784611702,
    0.025196190923452377,
    0.024484261870384216,
    0.02418249100446701,
    0.024266058579087257,
    0.024741727858781815,
    0.025649012997746468,
    0.027068454772233963,
    0.02914074808359146,
    0.03210511431097984,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.08154026418924332,
    0.4780718982219696,
    0.3471904695034027,
    0.40979763865470886,
    0.33093956112861633,
    0.12774471938610077,
    0.2258983850479126,
    0.19412241876125336,
    0.0699082463979721,
    0.061508193612098694,
    0.05566595867276192,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.04554778337478638,
    0.0469503253698349,
    0.04925423115491867,
    0.052669137716293335,
    0.05756601318717003,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.10870824009180069,
    0.2903081476688385,
    0.19524239003658295,
    0.44379305839538574,
    0.3930048644542694,
    0.1347915232181549,
    0.06913679838180542,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.0045279692858457565,
    0.43315500020980835,
    0.0,
    0.5,
    0.5,
    0.2699264585971832,
    0.41499999165534973,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_2 = [
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5600000023841858,
    1.0,
    1.0,
    0.5600000023841858,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5199999809265137,
    0.7099999785423279,
    0.8999999761581421,
    1.0,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.3400000035762787,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.3400000035762787,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.8999999761581421,
    0.18000000715255737,
    0.10999999940395355,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.30000001192092896,
    0.5,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.5,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_3 = [
    0.17000000178813934,
    0.18000000715255737,
    0.18000000715255737,
    0.1899999976158142,
    0.20000000298023224,
    0.2199999988079071,
    0.23999999463558197,
    0.27000001072883606,
    0.33000001311302185,
    0.4099999964237213,
    0.5600000023841858,
    1.0,
    1.0,
    0.550000011920929,
    0.18000000715255737,
    0.10999999940395355,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.029999999329447746,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.7099999785423279,
    0.8799999952316284,
    1.0,
    0.4099999964237213,
    0.33000001311302185,
    0.27000001072883606,
    0.23999999463558197,
    0.2199999988079071,
    0.20000000298023224,
    0.1899999976158142,
    0.18000000715255737,
    0.18000000715255737,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.17000000178813934,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.27000001072883606,
    0.1899999976158142,
    0.4099999964237213,
    0.10999999940395355,
    0.18000000715255737,
    0.5600000023841858,
    0.550000011920929,
    0.18000000715255737,
    0.10999999940395355,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.029999999329447746,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.7099999785423279,
    0.7400000095367432,
    0.7799999713897705,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.23999999463558197,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.18000000715255737,
    0.18000000715255737,
    0.30000001192092896,
    0.4300000071525574,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.4300000071525574,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_pg_map(render=False):
    env = MetaDriveEnv(
        {
            "use_render": render,
            # "debug_static_world": render,
            # "debug": render,
            "num_scenarios": 1,
            "traffic_density": 0,
            "start_seed": 74,
            "map": 1,
            "vehicle_config": {
                "lidar": dict(num_lasers=10, distance=50),
                "side_detector": dict(num_lasers=50, distance=50),
                "lane_line_detector": dict(num_lasers=50, distance=50),
            },
        }
    )
    try:
        env.reset()
        env.vehicle.set_position([73, 12])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(pg_gt_1, np.round(o, 2), decimal=2)

        env.vehicle.set_position([30, 3.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_2), o, decimal=2)

        env.vehicle.set_position([30, 10.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_3), o, decimal=2)
    finally:
        env.close()


nuscenes_gt_1 = [
    0.09075836837291718,
    0.09217655658721924,
    0.09512815624475479,
    0.09983516484498978,
    0.10680326074361801,
    0.11676304042339325,
    0.13101108372211456,
    0.15133066475391388,
    0.1828141212463379,
    0.23759107291698456,
    0.3464219272136688,
    0.5152920484542847,
    1.0,
    1.0,
    0.7216349840164185,
    0.4785699248313904,
    0.3620630204677582,
    0.2945554852485657,
    0.2518192529678345,
    0.22320537269115448,
    0.20315533876419067,
    0.18915221095085144,
    0.1796053946018219,
    0.17358174920082092,
    0.1705060601234436,
    0.17026464641094208,
    0.17269740998744965,
    0.17804943025112152,
    0.1867835521697998,
    0.1997312605381012,
    0.21826286613941193,
    0.24478337168693542,
    0.28362220525741577,
    0.3439479172229767,
    0.44482824206352234,
    1.0,
    0.2166164666414261,
    0.3294956684112549,
    0.5083940625190735,
    0.6360813975334167,
    0.2537195086479187,
    0.1899668127298355,
    0.1564241647720337,
    0.13358616828918457,
    0.11820273101329803,
    0.10741100460290909,
    0.10005706548690796,
    0.09534399211406708,
    0.09228239208459854,
    0.0907929316163063,
    0.5260613560676575,
    0.4140831232070923,
    0.5,
    0.5,
    0.5,
    5.327035069058184e-06,
    0.09075836837291718,
    0.09217655658721924,
    0.09512815624475479,
    0.09983516484498978,
    0.10680326074361801,
    0.11676304042339325,
    0.13101108372211456,
    0.15133066475391388,
    0.1828141212463379,
    0.23759107291698456,
    0.3464219272136688,
    0.5152920484542847,
    1.0,
    1.0,
    0.13423743844032288,
    0.08499369770288467,
    0.0641968622803688,
    0.17124241590499878,
    0.2518192529678345,
    0.12980437278747559,
    0.11819363385438919,
    0.18915221095085144,
    0.03174185752868652,
    0.03066714107990265,
    0.03012210875749588,
    0.030061468482017517,
    0.030481763184070587,
    0.03141583874821663,
    0.032944608479738235,
    0.03521450608968735,
    0.03834288939833641,
    0.24478337168693542,
    0.28362220525741577,
    0.3439479172229767,
    0.26837339997291565,
    1.0,
    0.2166164666414261,
    0.3294956684112549,
    0.5083940625190735,
    0.6360813975334167,
    0.2537195086479187,
    0.1899668127298355,
    0.1564241647720337,
    0.13358616828918457,
    0.11820273101329803,
    0.10741100460290909,
    0.10005706548690796,
    0.09534399211406708,
    0.09228239208459854,
    0.0907929316163063,
    0.5623959898948669,
    0.5623959898948669,
    0.5956567525863647,
    0.5956567525863647,
    0.6289005875587463,
    0.6289005875587463,
    0.6621062755584717,
    0.6621062755584717,
    0.6952372789382935,
    0.6952372789382935,
    0.7282377481460571,
    0.7282377481460571,
    0.7610746622085571,
    0.7610746622085571,
    0.7936805486679077,
    0.7936805486679077,
    0.8258141875267029,
    0.8258141875267029,
    0.5182746052742004,
    0.5082993507385254,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]
nuscenes_gt_2 = [
    1.0,
    0.7808130979537964,
    0.4014144241809845,
    0.497048556804657,
    0.21977420151233673,
    0.1833307445049286,
    0.2741309106349945,
    0.24397589266300201,
    0.22296150028705597,
    0.20816059410572052,
    0.19839195907115936,
    0.19227449595928192,
    0.18942095339298248,
    0.1900409460067749,
    0.19369441270828247,
    0.20063060522079468,
    0.1172584742307663,
    0.12590330839157104,
    0.13827820122241974,
    0.15608078241348267,
    0.18244224786758423,
    0.2237718254327774,
    0.2953447997570038,
    0.4444361925125122,
    0.9753275513648987,
    0.11675211787223816,
    0.04168549180030823,
    0.038301981985569,
    0.035907551646232605,
    0.034303370863199234,
    0.033339571207761765,
    0.03293364867568016,
    0.03305203467607498,
    0.035654980689287186,
    0.0451875701546669,
    0.06304079294204712,
    1.0,
    0.9279412627220154,
    0.47582244873046875,
    0.3268144130706787,
    0.25280630588531494,
    0.20891083776950836,
    0.18038643896579742,
    0.16094817221164703,
    0.1473899632692337,
    0.1379445493221283,
    0.1312660276889801,
    0.1269902139902115,
    0.12537911534309387,
    0.1267208307981491,
    0.3988616168498993,
    0.39293304085731506,
    0.5,
    0.5,
    0.5,
    0.00011851061572087929,
    1.0,
    0.7808130979537964,
    0.4014144241809845,
    0.497048556804657,
    0.21977420151233673,
    0.1833307445049286,
    0.2741309106349945,
    0.24397589266300201,
    0.22296150028705597,
    0.20816059410572052,
    0.19839195907115936,
    0.19227449595928192,
    0.18942095339298248,
    0.1900409460067749,
    0.19369441270828247,
    0.20063060522079468,
    0.1172584742307663,
    0.12590330839157104,
    0.13827820122241974,
    0.15608078241348267,
    0.18244224786758423,
    0.2237718254327774,
    0.2953447997570038,
    0.4444361925125122,
    0.9753275513648987,
    0.11675211787223816,
    0.04168549180030823,
    0.038301981985569,
    0.035907551646232605,
    0.034303370863199234,
    0.033339571207761765,
    0.03293364867568016,
    0.03305203467607498,
    0.035654980689287186,
    0.0451875701546669,
    0.06304079294204712,
    1.0,
    0.9279412627220154,
    0.47582244873046875,
    0.3268144130706787,
    0.25280630588531494,
    0.20891083776950836,
    0.18038643896579742,
    0.16094817221164703,
    0.1473899632692337,
    0.1379445493221283,
    0.1312660276889801,
    0.1269902139902115,
    0.12537911534309387,
    0.1267208307981491,
    0.4396708011627197,
    0.4396708011627197,
    0.4618304371833801,
    0.4618304371833801,
    0.483804315328598,
    0.483804315328598,
    0.505452036857605,
    0.505452036857605,
    0.5266749858856201,
    0.5266749858856201,
    0.547338604927063,
    0.547338604927063,
    0.5673576593399048,
    0.5673576593399048,
    0.5866857767105103,
    0.5866857767105103,
    0.6053164601325989,
    0.6053164601325989,
    0.0,
    0.46758297085762024,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_nuscenes(render=False):
    from metadrive.engine.asset_loader import AssetLoader
    from metadrive.envs.scenario_env import ScenarioEnv

    NuScenesEnv = ScenarioEnv

    env = NuScenesEnv(
        {
            "use_render": render,
            # "agent_policy": ReplayEgoCarPolicy,
            "no_traffic": True,
            "debug_static_world": render,
            "debug": render,
            "show_sidewalk": True,
            "show_crosswalk": True,
            "camera_dist": 9,
            "start_scenario_index": 0,
            "num_scenarios": 10,
            "horizon": 1000,
            "vehicle_config": dict(
                show_navi_mark=False,
                lidar=dict(num_lasers=10, distance=50),
                lane_line_detector=dict(num_lasers=50, distance=50),
                side_detector=dict(num_lasers=50, distance=50)
            ),
            "data_directory": AssetLoader.file_path("nuscenes", unix_style=False),
        }
    )
    try:
        env.reset(seed=0)
        env.vehicle.set_position([-9.4, -27.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_1, o, decimal=3)

        env.reset(seed=1)
        env.vehicle.set_position([79.96, -6.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_2, o, decimal=3)
    finally:
        env.close()


if __name__ == '__main__':
    # test_nuscenes(True)
    test_pg_map(True)
